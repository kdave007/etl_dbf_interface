<div class="setup-container">
  <div class="setup-header">
    <div class="header-content">
      <h1 class="setup-title">Configuración</h1>
      <p class="setup-subtitle">Administra los parámetros de sincronización y base de datos.</p>
    </div>
    <div class="plaza-selector-wrapper">
      <label class="plaza-label">Sucursal:</label>
      <nb-select [(selected)]="selectedSucursal" 
                 (selectedChange)="onSucursalChange($event)"
                 placeholder="Seleccione una sucursal"
                 [disabled]="loadingSucursales || sucursales.length === 0"
                 class="plaza-select">
        <nb-option *ngIf="loadingSucursales" value="">Cargando...</nb-option>
        <nb-option *ngFor="let sucursal of sucursales" [value]="sucursal.value">
          {{ sucursal.label }}
        </nb-option>
      </nb-select>
    </div>
  </div>

  <div *ngIf="selectedSucursal" class="config-sections">
    <nb-alert *ngIf="!isAdmin" status="warning" closable>
      <strong>Modo Solo Lectura:</strong> No tienes permisos de administrador. Puedes ver la configuración pero no guardar cambios.
    </nb-alert>
    
    <div class="section-row">
      <nb-card class="config-section">
        <nb-card-body>
          <div class="section-header">
            <nb-icon icon="settings-2-outline" class="section-icon"></nb-icon>
            <h3 class="section-title">General Settings</h3>
          </div>

          <div class="form-field">
            <label class="field-label">DB Name</label>
            <input nbInput 
                   [(ngModel)]="config.DB_NAME"
                   placeholder="XMIGU"
                   class="field-input">
          </div>

          <div class="form-field">
            <label class="field-label">Version</label>
            <input nbInput 
                   [(ngModel)]="config.VERSION"
                   placeholder="batch_001"
                   class="field-input">
          </div>

          <div class="form-row">
            <div class="form-field half-width">
              <label class="field-label">Debug</label>
              <nb-toggle [(checked)]="config.DEBUG"></nb-toggle>
            </div>

            <div class="form-field half-width">
              <label class="field-label">Stop Flag</label>
              <nb-toggle [(checked)]="config.STOP_FLAG"></nb-toggle>
            </div>
          </div>
        </nb-card-body>
      </nb-card>

      <nb-card class="config-section">
        <nb-card-body>
          <div class="section-header">
            <nb-icon icon="sync-outline" class="section-icon"></nb-icon>
            <h3 class="section-title">Sync & Database</h3>
          </div>

          <div class="form-row">
            <div class="form-field half-width">
              <label class="field-label">DBF Chunks Size</label>
              <input nbInput 
                     type="number"
                     [(ngModel)]="config.DBF_CHUNKS_SIZE"
                     placeholder="500"
                     class="field-input">
            </div>

            <div class="form-field half-width">
              <label class="field-label">SQL Enabled</label>
              <nb-toggle [(checked)]="config.SQL_ENABLED"></nb-toggle>
            </div>
          </div>

          <div class="form-field">
            <label class="field-label">Post API Base</label>
            <div class="input-with-icon">
              <nb-icon icon="link-2-outline" class="input-icon"></nb-icon>
              <input nbInput 
                     [(ngModel)]="config.POST_API_BASE"
                     placeholder="http://canovas.camposreye..."
                     class="field-input with-icon">
            </div>
          </div>

          <div class="form-field">
            <label class="field-label">Status API Base</label>
            <div class="input-with-icon">
              <nb-icon icon="link-2-outline" class="input-icon"></nb-icon>
              <input nbInput 
                     [(ngModel)]="config.STATUS_API_BASE"
                     placeholder="http://canovas.camposreye..."
                     class="field-input with-icon">
            </div>
          </div>
        </nb-card-body>
      </nb-card>
    </div>

    <nb-card class="config-section full-width">
      <nb-card-body>
        <div class="section-header">
          <nb-icon icon="calendar-outline" class="section-icon"></nb-icon>
          <h3 class="section-title">Data Range & Operations</h3>
        </div>

        <div class="form-row">
          <div class="form-field third-width">
            <label class="field-label">Start Date</label>
            <input nbInput 
                   type="date"
                   [(ngModel)]="config.START_DATE"
                   placeholder="mm/dd/yyyy"
                   class="field-input">
          </div>

          <div class="form-field third-width">
            <label class="field-label">Custom Date Range</label>
            <nb-toggle [(checked)]="config.CUSTOM_DATE_RANGE"></nb-toggle>
          </div>

          <div class="form-field third-width">
            <label class="field-label">Update Items</label>
            <input nbInput 
                   [(ngModel)]="config.UPDATE"
                   placeholder="items"
                   class="field-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-field third-width">
            <label class="field-label">End Date (Offset)</label>
            <input nbInput 
                   type="number"
                   [(ngModel)]="config.END_DATE"
                   placeholder="0"
                   class="field-input">
          </div>

          <div class="form-field third-width">
            <label class="field-label">Create Items</label>
            <input nbInput 
                   [(ngModel)]="config.CREATE"
                   placeholder="items"
                   class="field-input">
          </div>

          <div class="form-field third-width">
            <label class="field-label">Delete Items</label>
            <input nbInput 
                   [(ngModel)]="config.DELETE"
                   placeholder="items"
                   class="field-input">
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="config-section full-width">
      <nb-card-body>
        <div class="section-header">
          <nb-icon icon="list-outline" class="section-icon"></nb-icon>
          <h3 class="section-title">Tables & Operations</h3>
        </div>

        <div class="form-field">
          <label class="field-label">Tables (comma-separated)</label>
          <input nbInput 
                 [(ngModel)]="config.TABLES"
                 placeholder="XCORTE,CANOTA,CUNOTA,VENTA,PARTVTA,COBRANZA,FLUJORES"
                 class="field-input">
        </div>

        <div class="form-field">
          <label class="field-label">Command Line (JSON)</label>
          <input nbInput 
                 [(ngModel)]="config.COMMAND_LINE"
                 placeholder='{"task":"replace_recno"}'
                 class="field-input">
        </div>

        <div class="form-row">
          <div class="form-field third-width">
            <label class="field-label">Key ID Bypass</label>
            <nb-toggle [(checked)]="config.KEY_ID_BYPASS"></nb-toggle>
          </div>

          <div class="form-field third-width">
            <label class="field-label">Special Operations</label>
            <nb-toggle [(checked)]="config.SPECIAL_OPS"></nb-toggle>
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="config-section full-width">
      <nb-card-body>
        <div class="section-header">
          <nb-icon icon="moon-outline" class="section-icon"></nb-icon>
          <h3 class="section-title">Night Sync Configuration</h3>
        </div>

        <div class="form-row">
          <div class="form-field third-width">
            <label class="field-label">Night Sync Enabled</label>
            <nb-toggle [(checked)]="config.NIGHT_SYNC_ENABLED"></nb-toggle>
          </div>

          <div class="form-field third-width">
            <label class="field-label">Night Sync Start</label>
            <input nbInput 
                   type="time"
                   [(ngModel)]="config.NIGHT_SYNC_START"
                   placeholder="21:00"
                   class="field-input">
          </div>

          <div class="form-field third-width">
            <label class="field-label">Night Sync End</label>
            <input nbInput 
                   type="time"
                   [(ngModel)]="config.NIGHT_SYNC_END"
                   placeholder="06:00"
                   class="field-input">
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <div class="action-buttons">
      <button nbButton 
              status="basic"
              size="large"
              (click)="resetConfig()"
              class="reset-button">
        <nb-icon icon="refresh-outline"></nb-icon>
        RESTABLECER
      </button>
      
      <button nbButton 
              status="info"
              size="large"
              (click)="openCopyToStoresModal()"
              [disabled]="!isAdmin"
              [nbTooltip]="!isAdmin ? 'Solo administradores pueden copiar configuraciones' : ''"
              class="copy-button">
        <nb-icon icon="copy-outline"></nb-icon>
        <nb-icon *ngIf="!isAdmin" icon="lock-outline"></nb-icon>
        COPIAR A OTRAS TIENDAS
      </button>
      
      <button nbButton 
              status="primary"
              size="large"
              (click)="saveConfig()"
              [disabled]="savingConfig || !isAdmin"
              [nbTooltip]="!isAdmin ? 'Solo administradores pueden guardar configuraciones' : ''"
              class="save-button">
        <nb-icon *ngIf="!savingConfig && isAdmin" icon="save-outline"></nb-icon>
        <nb-icon *ngIf="!savingConfig && !isAdmin" icon="lock-outline"></nb-icon>
        <nb-icon *ngIf="savingConfig" icon="loader-outline" class="spin"></nb-icon>
        {{ savingConfig ? 'GUARDANDO...' : 'GUARDAR CONFIGURACIÓN' }}
      </button>
    </div>
  </div>
</div>

<ng-template #copyToStoresDialog let-data let-ref="dialogRef">
  <nb-card>
    <nb-card-header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h5>Copiar Configuración a Otras Tiendas</h5>
        <button nbButton ghost (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div style="margin-bottom: 1rem;">
        <nb-alert status="warning" style="margin-bottom: 1rem;">
          <strong>Nota:</strong> El campo <strong>DB_NAME</strong> NO será copiado para mantener nombres únicos por tienda.
        </nb-alert>
        
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button nbButton size="small" status="basic" (click)="selectAllStores()">
            Seleccionar Todas
          </button>
          <button nbButton size="small" status="basic" (click)="clearAllStores()">
            Limpiar Selección
          </button>
        </div>

        <div style="max-height: 300px; overflow-y: auto;">
          <div *ngFor="let store of sucursales" style="margin-bottom: 0.5rem;">
            <nb-checkbox 
              *ngIf="store.value !== selectedSucursal"
              [checked]="isStoreSelected(store.value)"
              (checkedChange)="toggleStoreSelection(store.value)">
              {{ store.label }} ({{ store.value }})
            </nb-checkbox>
          </div>
        </div>

        <div style="margin-top: 1rem; padding: 0.5rem;  border-radius: 4px;">
          <strong>Tiendas seleccionadas:</strong> {{ selectedStoresForCopy.size }}
        </div>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
        <button nbButton status="basic" (click)="ref.close()">
          Cancelar
        </button>
        <button nbButton 
                status="primary" 
                [disabled]="selectedStoresForCopy.size === 0 || copyingToStores"
                (click)="copyConfigToStores(ref)">
          <nb-icon *ngIf="!copyingToStores" icon="copy-outline"></nb-icon>
          <nb-icon *ngIf="copyingToStores" icon="loader-outline" class="spin"></nb-icon>
          {{ copyingToStores ? 'Copiando...' : 'Copiar Configuración' }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>
