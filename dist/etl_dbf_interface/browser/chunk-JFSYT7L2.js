import{a as ie}from"./chunk-R2G55BTQ.js";import{a as oe}from"./chunk-D7B2MET4.js";import{a as ae}from"./chunk-TRXHS44N.js";import{a as ne}from"./chunk-PCI3NK2F.js";import{$ as y,B as r,Ca as U,D as _,Da as V,E as m,G as b,Ga as W,H as P,I as p,K as j,L as o,M as a,Ma as G,N as d,P as u,Q as C,Qa as q,Ra as $,Sa as X,Ta as Y,V as c,Va as Z,W as g,Wa as J,X as A,Xa as K,Y as S,Ya as Q,_ as M,a as k,aa as O,b as E,g as T,ha as R,ia as B,ja as x,la as v,n as N,oa as H,p as I,s as L,sb as ee,tb as te,v as h,w as F}from"./chunk-HIEGVO2R.js";var f=class i{constructor(t,e){this.http=t;this.plazaService=e}clientStatusSubject=new T(null);clientStatus$=this.clientStatusSubject.asObservable();getClientConnections(t){let n=`${this.plazaService.getApiUrl(t)}/api/clients_status_by_plaza`,s={city:{xalap:"XALAP",chetu:"CHETU",penla:"PENLA",valla:"VALLA",manza:"MANZA",reyes:"REYES"}[t]||t.toUpperCase()};return this.http.post(n,s)}updateClientStatus(t){this.clientStatusSubject.next(t)}static \u0275fac=function(e){return new(e||i)(I(H),I(ae))};static \u0275prov=N({token:i,factory:i.\u0275fac,providedIn:"root"})};function de(i,t){if(i&1&&(o(0,"tr",12)(1,"td"),c(2),a(),o(3,"td"),c(4),a(),o(5,"td",13),c(6),a(),o(7,"td")(8,"span",14),d(9,"nb-icon",15),c(10),a()(),o(11,"td"),c(12),a()()),i&2){let e=t.$implicit,n=C();r(2),g(e.client_id),r(2),g(e.location),r(2),g(e.city),r(2),p("ngClass",n.getStatusClass(e.status||"Disconnected")),r(),p("icon",n.getStatusIcon(e.status||"Disconnected")),r(),A(" ",e.status||"Disconnected"," "),r(2),g(n.formatLastSeen(e.last_seen))}}function pe(i,t){i&1&&(o(0,"div",16),d(1,"nb-icon",17),o(2,"p"),c(3,"No connections found"),a()())}var w=class i{constructor(t){this.clientStatusService=t}selectedCity="xalap";isLoading=!1;connections=[];filteredConnections=[];paginatedConnections=[];searchTerm="";currentPage=1;pageSize=50;totalPages=1;Math=Math;ngOnInit(){this.fetchClientConnections()}ngOnChanges(t){t.selectedCity&&!t.selectedCity.firstChange&&this.fetchClientConnections()}fetchClientConnections(){this.isLoading=!0,this.clientStatusService.getClientConnections(this.selectedCity).subscribe({next:t=>{t.success&&(this.connections=t.data.map(e=>E(k({},e),{status:this.determineStatus(e.last_seen)})),this.applyFilters(),this.clientStatusService.updateClientStatus(t)),this.isLoading=!1},error:t=>{console.error("Error fetching client connections:",t),this.isLoading=!1}})}determineStatus(t){let e=new Date(t),n=new Date,l=(n.getTime()-e.getTime())/(1e3*60),s=e.toDateString()===n.toDateString();return l<120?"Connected":s&&l>=120?"Disconnected":"Error"}refreshData(){this.fetchClientConnections()}filterConnections(){this.applyFilters()}applyFilters(){let t=[...this.connections];if(this.searchTerm){let e=this.searchTerm.toLowerCase();t=t.filter(n=>n.client_id.toLowerCase().includes(e)||n.location.toLowerCase().includes(e)||n.status&&n.status.toLowerCase().includes(e))}this.filteredConnections=t,this.updatePagination()}updatePagination(){this.totalPages=Math.ceil(this.filteredConnections.length/this.pageSize),this.currentPage>this.totalPages&&(this.currentPage=1);let t=(this.currentPage-1)*this.pageSize,e=t+this.pageSize;this.paginatedConnections=this.filteredConnections.slice(t,e)}onPageChange(t){this.currentPage=t,this.updatePagination()}getStatusIcon(t){switch(t){case"Connected":return"checkmark-circle-outline";case"Disconnected":return"close-circle-outline";case"Error":return"alert-triangle-outline";default:return"question-mark-circle-outline"}}getStatusClass(t){switch(t){case"Connected":return"status-connected";case"Disconnected":return"status-disconnected";case"Error":return"status-error";default:return""}}formatLastSeen(t){return new Date(t).toLocaleString("es-MX",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}static \u0275fac=function(e){return new(e||i)(_(f))};static \u0275cmp=m({type:i,selectors:[["app-connections-table"]],inputs:{selectedCity:"selectedCity"},features:[L],decls:31,vars:9,consts:[[1,"header-content"],[1,"header-actions"],[1,"search-box"],["nbInput","","type","text","placeholder","Filtrar...",3,"ngModelChange","ngModel"],["icon","search-outline"],["nbButton","","size","small","status","primary","title","Actualizar datos",3,"click","disabled"],["icon","refresh-outline"],[1,"table-container"],[1,"connections-table"],["class","table-row",4,"ngFor","ngForOf"],["class","no-data",4,"ngIf"],[3,"pageChange","currentPage","pageSize","totalRecords"],[1,"table-row"],[1,"city-cell"],[1,"status-badge",3,"ngClass"],[3,"icon"],[1,"no-data"],["icon","inbox-outline"]],template:function(e,n){e&1&&(o(0,"nb-card")(1,"nb-card-header")(2,"div",0)(3,"h5"),c(4,"Conexiones"),a(),o(5,"div",1)(6,"div",2)(7,"input",3),O("ngModelChange",function(s){return y(n.searchTerm,s)||(n.searchTerm=s),s}),u("ngModelChange",function(){return n.filterConnections()}),a(),d(8,"nb-icon",4),a(),o(9,"button",5),u("click",function(){return n.refreshData()}),d(10,"nb-icon",6),c(11," Actualizar "),a()()()(),o(12,"nb-card-body")(13,"div",7)(14,"table",8)(15,"thead")(16,"tr")(17,"th"),c(18,"Client ID"),a(),o(19,"th"),c(20,"Sucursal"),a(),o(21,"th"),c(22,"Plaza"),a(),o(23,"th"),c(24,"Estatus"),a(),o(25,"th"),c(26,"Ultima conexi\xF3n"),a()()(),o(27,"tbody"),b(28,de,13,7,"tr",9),a()(),b(29,pe,4,0,"div",10),o(30,"app-table-pagination",11),u("pageChange",function(s){return n.onPageChange(s)}),a()()()()),e&2&&(r(7),M("ngModel",n.searchTerm),r(2),p("disabled",n.isLoading),r(),j("spinning",n.isLoading),r(18),p("ngForOf",n.paginatedConnections),r(),p("ngIf",n.filteredConnections.length===0),r(),p("currentPage",n.currentPage)("pageSize",n.pageSize)("totalRecords",n.filteredConnections.length))},dependencies:[v,R,B,x,J,Z,Y,X,$,q,oe,te,ee,Q,K,G,U,V,W,ie],styles:[".header-content[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;width:100%}.header-content[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{margin:0;font-weight:600;color:#fff}.header-content[_ngcontent-%COMP%]   .header-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem}.header-content[_ngcontent-%COMP%]   .search-box[_ngcontent-%COMP%]{position:relative;width:300px}.header-content[_ngcontent-%COMP%]   .search-box[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding-right:2.5rem}.header-content[_ngcontent-%COMP%]   .search-box[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);color:#a4abb3;pointer-events:none}.header-content[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;white-space:nowrap}.header-content[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{font-size:1.2rem;transition:transform .3s ease}.header-content[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   nb-icon.spinning[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.table-container[_ngcontent-%COMP%]{overflow-x:auto;min-height:300px}.connections-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.connections-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{background-color:#598bff26;border-bottom:2px solid rgba(89,139,255,.3)}.connections-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:1rem;text-align:left;font-weight:600;color:#fff;font-size:.875rem;text-transform:uppercase;letter-spacing:.5px}.connections-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]{border-bottom:1px solid rgba(255,255,255,.1);transition:background-color .2s ease}.connections-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]:hover{background-color:#ffffff0d}.connections-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:1rem;color:#fff;font-size:.875rem}.connections-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]   td.city-cell[_ngcontent-%COMP%]{color:#a4abb3;font-style:italic}.status-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .75rem;border-radius:1rem;font-size:.75rem;font-weight:600}.status-badge[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{font-size:1rem}.status-badge.status-connected[_ngcontent-%COMP%]{background-color:#00d68f33;color:#00d68f}.status-badge.status-connected[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{color:#00d68f}.status-badge.status-disconnected[_ngcontent-%COMP%]{background-color:#fa03;color:#fa0}.status-badge.status-disconnected[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{color:#fa0}.status-badge.status-error[_ngcontent-%COMP%]{background-color:#ff3d7133;color:#ff3d71}.status-badge.status-error[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{color:#ff3d71}.no-data[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;color:#a4abb3}.no-data[_ngcontent-%COMP%]   nb-icon[_ngcontent-%COMP%]{font-size:4rem;margin-bottom:1rem;opacity:.5}.no-data[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:1rem}"]})};function ge(i,t){if(i&1&&(h(),d(0,"circle",15)),i&2){let e=C();P("stroke-dasharray",e.getStrokeDasharray(e.stats.connectedPercent))("stroke-dashoffset",e.getStrokeDashoffset(0))}}function me(i,t){if(i&1&&(h(),d(0,"circle",16)),i&2){let e=C();P("stroke-dasharray",e.getStrokeDasharray(e.stats.disconnectedPercent))("stroke-dashoffset",e.getStrokeDashoffset(e.stats.connectedPercent))}}function ue(i,t){if(i&1&&(h(),d(0,"circle",17)),i&2){let e=C();P("stroke-dasharray",e.getStrokeDasharray(e.stats.errorPercent))("stroke-dashoffset",e.getStrokeDashoffset(e.stats.connectedPercent+e.stats.disconnectedPercent))}}var D=class i{constructor(t){this.clientStatusService=t;this.subscription=this.clientStatusService.clientStatus$.subscribe(e=>{e&&e.success&&this.calculateStats(e.data)})}stats={connected:0,disconnected:0,error:0,total:0,connectedPercent:0,disconnectedPercent:0,errorPercent:0};subscription;ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}calculateStats(t){let e={connected:0,disconnected:0,error:0,total:t.length,connectedPercent:0,disconnectedPercent:0,errorPercent:0};t.forEach(n=>{let l=this.determineStatus(n.last_seen);l==="Connected"?e.connected++:l==="Disconnected"?e.disconnected++:e.error++}),e.total>0&&(e.connectedPercent=Math.round(e.connected/e.total*100),e.disconnectedPercent=Math.round(e.disconnected/e.total*100),e.errorPercent=Math.round(e.error/e.total*100)),this.stats=e}determineStatus(t){let e=new Date(t),n=new Date,l=(n.getTime()-e.getTime())/(1e3*60),s=e.toDateString()===n.toDateString();return l<120?"Connected":s&&l>=120?"Disconnected":"Error"}getStrokeDasharray(t){let e=2*Math.PI*45;return`${e*(t/100)} ${e}`}getStrokeDashoffset(t){return`${-(2*Math.PI*45)*(t/100)}`}static \u0275fac=function(e){return new(e||i)(_(f))};static \u0275cmp=m({type:i,selectors:[["app-status-chart"]],decls:24,vars:10,consts:[[1,"status-chart-container"],[1,"chart-wrapper"],["viewBox","0 0 100 100",1,"circular-chart"],["cx","50","cy","50","r","45",1,"circle-bg"],["class","circle-connected","cx","50","cy","50","r","45",4,"ngIf"],["class","circle-disconnected","cx","50","cy","50","r","45",4,"ngIf"],["class","circle-error","cx","50","cy","50","r","45",4,"ngIf"],["x","50","y","50",1,"chart-total"],["x","50","y","60",1,"chart-label"],[1,"legend"],[1,"legend-item"],[1,"legend-color","connected"],[1,"legend-text"],[1,"legend-color","disconnected"],[1,"legend-color","error"],["cx","50","cy","50","r","45",1,"circle-connected"],["cx","50","cy","50","r","45",1,"circle-disconnected"],["cx","50","cy","50","r","45",1,"circle-error"]],template:function(e,n){e&1&&(o(0,"div",0)(1,"div",1),h(),o(2,"svg",2),d(3,"circle",3),b(4,ge,1,2,"circle",4)(5,me,1,2,"circle",5)(6,ue,1,2,"circle",6),o(7,"text",7),c(8),a(),o(9,"text",8),c(10,"Clients"),a()()(),F(),o(11,"div",9)(12,"div",10),d(13,"span",11),o(14,"span",12),c(15),a()(),o(16,"div",10),d(17,"span",13),o(18,"span",12),c(19),a()(),o(20,"div",10),d(21,"span",14),o(22,"span",12),c(23),a()()()()),e&2&&(r(4),p("ngIf",n.stats.connectedPercent>0),r(),p("ngIf",n.stats.disconnectedPercent>0),r(),p("ngIf",n.stats.errorPercent>0),r(2),g(n.stats.total),r(7),S("Connected: ",n.stats.connected," (",n.stats.connectedPercent,"%)"),r(4),S("Disconnected: ",n.stats.disconnected," (",n.stats.disconnectedPercent,"%)"),r(4),S("Error: ",n.stats.error," (",n.stats.errorPercent,"%)"))},dependencies:[v,x],styles:[".status-chart-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:1.5rem;padding:1rem}.chart-wrapper[_ngcontent-%COMP%]{width:200px;height:200px}.circular-chart[_ngcontent-%COMP%]{width:100%;height:100%;transform:rotate(-90deg)}.circle-bg[_ngcontent-%COMP%]{fill:none;stroke:#eee;stroke-width:10}.circle-connected[_ngcontent-%COMP%], .circle-disconnected[_ngcontent-%COMP%], .circle-error[_ngcontent-%COMP%]{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dasharray .3s ease}.circle-connected[_ngcontent-%COMP%]{stroke:#00d68f}.circle-disconnected[_ngcontent-%COMP%]{stroke:#fa0}.circle-error[_ngcontent-%COMP%]{stroke:#ff3d71}.chart-total[_ngcontent-%COMP%]{fill:#222b45;font-size:20px;font-weight:700;text-anchor:middle;dominant-baseline:middle;transform:rotate(90deg);transform-origin:50px 50px}.chart-label[_ngcontent-%COMP%]{fill:#8f9bb3;font-size:8px;text-anchor:middle;dominant-baseline:middle;transform:rotate(90deg);transform-origin:50px 50px}.legend[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem;width:100%;max-width:250px;color:#f4f7f7}.legend-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.legend-color[_ngcontent-%COMP%]{width:16px;height:16px;border-radius:3px;flex-shrink:0}.legend-color.connected[_ngcontent-%COMP%]{background-color:#00d68f}.legend-color.disconnected[_ngcontent-%COMP%]{background-color:#fa0}.legend-color.error[_ngcontent-%COMP%]{background-color:#ff3d71}.legend-text[_ngcontent-%COMP%]{font-size:.875rem;color:#dde0e1}"]})};var se=class i{selectedCity="xalap";onPlazaChange(t){this.selectedCity=t}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=m({type:i,selectors:[["app-client-status"]],decls:3,vars:2,consts:[[3,"selectedPlazaChange","selectedPlaza"],[3,"selectedCity"]],template:function(e,n){e&1&&(o(0,"app-plaza-selector",0),O("selectedPlazaChange",function(s){return y(n.selectedCity,s)||(n.selectedCity=s),s}),u("selectedPlazaChange",function(s){return n.onPlazaChange(s)}),a(),d(1,"app-status-chart")(2,"app-connections-table",1)),e&2&&(M("selectedPlaza",n.selectedCity),r(2),p("selectedCity",n.selectedCity))},dependencies:[ne,w,D],encapsulation:2})};export{se as ClientStatusComponent};
